---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import SectionHeading from '../components/SectionHeading.astro';
import NewsStrip from '../components/NewsStrip.astro';
import HighlightsRow from '../components/HighlightsRow.astro';
import PublicationCard from '../components/PublicationCard.astro';
import { getCollection, getEntry } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import headshot from '../assets/headshot.jpg';

const about = await getEntry('pages', 'about');
const experience = await getEntry('pages', 'experience');
const aboutRendered = await about.render();
const experienceItems = experience.data.items ?? [];
const experienceIntro = experience.data.intro ??
  'Delivery-focused research, teaching, and internships where I translate multimodal ML into rigorously evaluated systems.';

const publicationEntries = await getCollection('publications');
const publications = publicationEntries.sort((a, b) => b.data.year - a.data.year);

const artifactEntries = await getCollection('artifacts');
const artifactMap = new Map<string, CollectionEntry<'artifacts'>[]>();
artifactEntries.forEach((artifact) => {
  artifact.data.tiesTo.forEach((slug) => {
    if (!artifactMap.has(slug)) {
      artifactMap.set(slug, []);
    }
    artifactMap.get(slug)?.push(artifact);
  });
});
const featuredArtifacts = [...artifactEntries]
  .sort((a, b) => a.data.name.localeCompare(b.data.name))
  .slice(0, 3);

const resumeHref = `${import.meta.env.BASE_URL}resume.pdf`;
const scholarHref = 'https://scholar.google.com/citations?user=srZXFMcAAAAJ&hl=en';
const githubHref = 'https://github.com/nmotlagh';
const linkedInHref = 'https://www.linkedin.com/in/nicholas-kashani-motlagh';
const emailHref = 'mailto:kashanimotlagh.1@osu.edu';
const siteOrigin = Astro.site?.href ?? 'https://nmotlagh.github.io';
const headshotUrl = Astro.site ? new URL(headshot.src, Astro.site).href : headshot.src;

const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Nick Kashani Motlagh',
  url: siteOrigin,
  jobTitle: 'Ph.D. Candidate; Research Scientist track 2025',
  affiliation: {
    '@type': 'CollegeOrUniversity',
    name: 'The Ohio State University',
  },
  email: emailHref,
  image: headshotUrl,
  sameAs: [githubHref, linkedInHref, scholarHref],
  knowsAbout: [
    'Vision-language models',
    'Uncertainty quantification',
    'Computer vision',
    'Multimodal machine learning',
    'Large language models',
  ],
};

const publicationSchemas = publications.map((pub) => {
  const isBasedOn = [pub.data.code, pub.data.data].filter(Boolean).map((url) => ({
    '@type': 'CreativeWork',
    url,
  }));
  return {
    '@context': 'https://schema.org',
    '@type': 'ScholarlyArticle',
    name: pub.data.title,
    url: `${siteOrigin}publications/${pub.slug}/`,
    datePublished: pub.data.datePublished ?? String(pub.data.year),
    publisher: pub.data.venue
      ? {
          '@type': 'Organization',
          name: pub.data.venue,
        }
      : undefined,
    author: pub.data.authors.map((author) => ({
      '@type': 'Person',
      name: author,
    })),
    isBasedOn: isBasedOn.length > 0 ? isBasedOn : undefined,
  };
});

const structuredData = [personSchema, ...publicationSchemas];
const publicationLookup = new Map(publications.map((entry) => [entry.slug, entry.data.title]));
---

<BaseLayout
  title="Home"
  description="Nick Kashani Motlagh is a machine learning engineer and Ph.D. candidate advancing production-ready, uncertainty-aware multimodal systems at The Ohio State University."
  structuredData={structuredData}
>
  <Hero
    eyebrow="Open research · Evaluation harnesses"
    title="Dependable LLM & multimodal systems for production"
    description="Selective prediction, abstention, and evaluation tooling so models know when to answer, when to say “I don’t know,” and when to hand off to humans."
    actions={[
      { label: 'Resume', href: resumeHref, external: true, analyticsEvent: 'hero_resume_click' },
      { label: 'Email', href: emailHref, variant: 'ghost', analyticsEvent: 'hero_email_click' },
    ]}
    links={[
      { label: 'Scholar', href: scholarHref, external: true },
      { label: 'GitHub', href: githubHref, external: true },
      { label: 'LinkedIn', href: linkedInHref, external: true },
    ]}
    meta={[
      'Focus: selective prediction, abstention policies, and calibration for LLMs and multimodal models',
      'Tooling: open-source evaluation harnesses, datasets, and reproducible code for analyst-facing systems',
      'Status: Ph.D. candidate, OSU Computer Vision Lab (M.S. 2025, Ph.D. expected 2026) · 2025 research scientist / ML engineer track · U.S. citizen',
    ]}
    stats={[
      { label: 'Focus', value: 'Selective prediction & LLM / multimodal reliability' },
      { label: 'Current role', value: 'Graduate Research Associate · OSU Computer Vision Lab' },
      { label: 'Impact', value: '8× OOD utility (LLM reject-option training) · +1.3% coverage (selective ImageNet classification)' },
      { label: 'Location', value: 'Columbus, OH · Open to relocation' },
    ]}
    image={{ src: headshot, alt: 'Portrait of Nick Kashani Motlagh' }}
  />

  <NewsStrip />
  <HighlightsRow />

  <section id="about" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading eyebrow="Profile" title="About" />
    </div>
    <div class="section__body">
      <div class="prose">
        <aboutRendered.Content />
      </div>
    </div>
  </section>

  <section id="experience" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading
        eyebrow="Background"
        title="Experience"
        description={experienceIntro}
      />
    </div>
    <div class="section__body">
      <div class="timeline">
        {experienceItems.map((item) => (
          <article class="timeline__item">
            <h3 class="timeline__title">{item.role}</h3>
            <p class="timeline__meta">
              {item.location}
              <span aria-hidden="true"> · </span>
              {item.timeframe}
            </p>
            {item.bullets && item.bullets.length > 0 && (
              <ul class="timeline__body">
                {item.bullets.map((bullet) => (
                  <li set:html={bullet} />
                ))}
              </ul>
            )}
          </article>
        ))}
      </div>
    </div>
  </section>

  <section id="education" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading eyebrow="Academics" title="Education" />
    </div>
    <div class="section__body">
      <div class="prose">
        <h3>Ohio State University — Columbus, OH</h3>
        <p>
          <strong>Ph.D. in Computer Science and Engineering</strong> — Aug 2021 – May 2026 (Expected)<br />
          <strong>M.S. in Computer Science and Engineering</strong> — Aug 2021 – May 2025<br />
          Advisor: Prof. Jim Davis · Minors: Mathematics and High-Performance Computing · GPA: 3.70
        </p>
        <p>
          <strong>B.S. in Computer Science and Engineering with Honors</strong> — Aug 2017 – May 2021<br />
          Minor: Mathematics · Scholarships: Maximus, Ten-Hai Lai, Ansel, Name and Seal · GPA: 3.86
        </p>
      </div>
    </div>
  </section>

  <section id="skills" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading eyebrow="Toolkit" title="Skills" />
    </div>
    <div class="section__body">
      <div class="prose skills-list">
        <p><strong>Machine learning &amp; modeling</strong></p>
        <ul>
          <li>Selective prediction and abstention policies for vision, multimodal MT, and LLMs</li>
          <li>Vision transformers, vision-language models, multimodal EO/SAR representation learning</li>
          <li>Evaluation harness design, calibration metrics, and selective accuracy analysis</li>
        </ul>

        <p><strong>Tools &amp; infrastructure</strong></p>
        <ul>
          <li>Python, PyTorch, HuggingFace, Git</li>
          <li>Slurm, Singularity, Linux HPC clusters</li>
          <li>Experiment tracking, report generation (HTML/Markdown), LaTeX</li>
        </ul>

        <p><strong>Domains</strong></p>
        <ul>
          <li>Analyst-facing tooling, defense and remote sensing applications</li>
          <li>Multimodal machine translation and imagery-aware evaluation</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="service" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading eyebrow="Community" title="Professional service" />
    </div>
    <div class="section__body">
      <div class="prose">
        <ul>
          <li>Reviewer: CVPR 2022–2023, ICCV 2023, ECCV 2022</li>
          <li>Volunteer: HackOHI/O 2023</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="publications" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading
        eyebrow="Research"
        title="Publications & articles"
        description="Peer-reviewed work spanning selective vision models, multimodal MT, and LLM abstention policies — with reproducible artifacts."
      />
    </div>
    <div class="section__body">
      <div class="publication-grid">
        {publications.map((pub) => (
          <PublicationCard entry={pub} artifacts={artifactMap.get(pub.slug)} />
        ))}
      </div>
      <div class="section__cta">
        <a class="button button--ghost" href={`${import.meta.env.BASE_URL}publications/`}>Browse publication archive</a>
      </div>
    </div>
  </section>

  <section id="artifacts" class="site-shell section section--split">
    <div class="section__lead">
      <SectionHeading
        eyebrow="Open source"
        title="Artifacts you can fork today"
        description="Pipelines, eval harnesses, and datasets that pair every paper with runnable code and reproducibility notes."
      />
    </div>
    <div class="section__body">
      <div class="artifact-grid">
        {featuredArtifacts.map((artifact) => (
          <article class="artifact-card card">
            <div class="artifact-card__header">
              <h3>
                <a href={artifact.data.repo} target="_blank" rel="noopener noreferrer">
                  {artifact.data.name}
                </a>
              </h3>
              {artifact.data.repo && (
                <a class="badge badge--link" href={artifact.data.repo} target="_blank" rel="noopener noreferrer">
                  GitHub
                </a>
              )}
            </div>
            <p>{artifact.data.summary}</p>
            <ul>
              {artifact.data.reproduce.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
            {artifact.data.tiesTo.length > 0 && (
              <p class="artifact-card__ties">
                Supports:&nbsp;
                {artifact.data.tiesTo
                  .map((slug) => ({ slug, title: publicationLookup.get(slug) }))
                  .filter((item): item is { slug: string; title: string } => Boolean(item.title))
                  .map((item, index, arr) => (
                    <span>
                      <a href={`${import.meta.env.BASE_URL}publications/${item.slug}/`}>{item.title}</a>
                      {index < arr.length - 1 ? ', ' : ''}
                    </span>
                  ))}
              </p>
            )}
          </article>
        ))}
      </div>
      <div class="section__cta">
        <a class="button" href={`${import.meta.env.BASE_URL}artifacts/`}>View all artifacts</a>
      </div>
    </div>
  </section>
</BaseLayout>
