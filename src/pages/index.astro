---
import BaseLayout from '../layouts/BaseLayout.astro';
import TechBadges from '../components/TechBadges.astro';
import Callout from '../components/Callout.astro';
import NewsStrip from '../components/NewsStrip.astro';
import HighlightsRow from '../components/HighlightsRow.astro';
import PublicationCard from '../components/PublicationCard.astro';
import { getCollection, getEntry } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import headshot from '../assets/headshot.jpg';

const about = await getEntry('pages', 'about');
const experience = await getEntry('pages', 'experience');
const aboutRendered = about ? await about.render() : undefined;
const experienceItems = experience?.data.items ?? [];

const publicationEntries = await getCollection('publications');
const publications = publicationEntries.sort((a, b) => b.data.year - a.data.year);

const artifactEntries = await getCollection('artifacts');
const artifactMap = new Map<string, CollectionEntry<'artifacts'>[]>();
artifactEntries.forEach((artifact) => {
  artifact.data.tiesTo.forEach((slug) => {
    if (!artifactMap.has(slug)) {
      artifactMap.set(slug, []);
    }
    artifactMap.get(slug)?.push(artifact);
  });
});
const featuredArtifacts = [...artifactEntries]
  .sort((a, b) => a.data.name.localeCompare(b.data.name))
  .slice(0, 6);

const resumeHref = `${import.meta.env.BASE_URL}resume.pdf`;
const scholarHref = 'https://scholar.google.com/citations?user=srZXFMcAAAAJ&hl=en';
const githubHref = 'https://github.com/nmotlagh';
const linkedInHref = 'https://www.linkedin.com/in/nicholas-kashani-motlagh';
const emailHref = 'mailto:kashanimotlagh.1@osu.edu';
const siteOrigin = Astro.site?.href ?? 'https://nmotlagh.github.io';
const headshotUrl = Astro.site ? new URL(headshot.src, Astro.site).href : headshot.src;

const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Nick Kashani Motlagh',
  url: siteOrigin,
  jobTitle: 'Ph.D. Candidate â€” Uncertainty & Calibration Research',
  affiliation: {
    '@type': 'CollegeOrUniversity',
    name: 'The Ohio State University',
  },
  email: emailHref,
  image: headshotUrl,
  sameAs: [githubHref, linkedInHref, scholarHref],
  knowsAbout: [
    'Machine Learning',
    'Computer Vision',
    'Uncertainty Quantification',
    'Multimodal Systems',
    'LLM Calibration',
    'Selective Prediction',
    'Reinforcement Learning',
  ],
};

const publicationSchemas = publications.map((pub) => {
  const isBasedOn = [pub.data.code, pub.data.data].filter(Boolean).map((url) => ({
    '@type': 'CreativeWork',
    url,
  }));
  return {
    '@context': 'https://schema.org',
    '@type': 'ScholarlyArticle',
    name: pub.data.title,
    url: `${siteOrigin}publications/${pub.slug}/`,
    datePublished: pub.data.datePublished ?? String(pub.data.year),
    publisher: pub.data.venue
      ? {
          '@type': 'Organization',
          name: pub.data.venue,
        }
      : undefined,
    author: pub.data.authors.map((author) => ({
      '@type': 'Person',
      name: author,
    })),
    isBasedOn: isBasedOn.length > 0 ? isBasedOn : undefined,
  };
});

const structuredData = [personSchema, ...publicationSchemas];
const publicationLookup = new Map(publications.map((entry) => [entry.slug, entry.data.title]));
---

<BaseLayout
  title="Home"
  description="Nick Kashani Motlagh â€” ML researcher at Ohio State teaching AI systems to stop guessing and start admitting what they don't know."
  structuredData={structuredData}
>
  <!-- INTRO SECTION -->
  <div class="hero-intro">
    <TechBadges />
    <p class="hero-intro__greeting">Hi, I'm Nick ðŸ‘‹</p>
    <h1 class="hero-intro__headline">
      I train AI systems to <span class="accent">know when they don't know</span>
    </h1>
    <p class="hero-intro__description">
      Language models make things up, and most of the time they have no idea they're doing it.
      My research at Ohio State trains models to either resolve their uncertainty or back out entirely, as fast as possible, instead of confidently guessing.
    </p>
    <p class="hero-intro__status">
      <strong>On the market:</strong> Research Scientist &amp; ML Engineering roles Â· PhD May 2026 Â· Columbus, OH Â· Will relocate
    </p>
    <div class="hero-intro__actions">
      <a class="button" href={resumeHref} target="_blank" rel="noopener noreferrer">
        View Resume (PDF)
      </a>
      <a class="button button--ghost" href={emailHref}>
        Discuss Opportunities
      </a>
    </div>
  </div>

  <!-- STATUS CALLOUT -->
  <Callout title="Currently" icon="ðŸŽ¯" variant="highlight">
    <p><strong>Graduate Research Associate</strong> at OSU's Computer Vision Lab, finishing my PhD in May 2026. Right now I am training language models to recognize when they are in a "dirty" region of the decision space and either correct course or abstain. Looking for research scientist or ML engineering roles, based in Columbus, OH, and happy to relocate.</p>
  </Callout>

  <!-- NEWS STRIP -->
  <NewsStrip />

  <!-- RESEARCH HIGHLIGHTS -->
  <HighlightsRow />

  <!-- EXPERIENCE SECTION -->
  <section id="experience" class="section">
    <div class="section__header">
      <h2 class="section__title">Experience</h2>
      <span class="section__subtitle">Research & industry</span>
    </div>
    <div class="timeline">
      {experienceItems.map((item) => (
        <article class="timeline-item">
          <div class="timeline-item__date">{item.timeframe}</div>
          <div class="timeline-item__content">
            <h3 class="timeline-item__title">{item.role}</h3>
            <p class="timeline-item__location">{item.location}</p>
            {item.bullets && item.bullets.length > 0 && (
              <ul class="timeline-item__bullets">
                {item.bullets.map((bullet) => (
                  <li set:html={bullet} />
                ))}
              </ul>
            )}
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- EDUCATION CALLOUT -->
  <Callout title="Education" icon="ðŸŽ“">
    <p><strong>Ohio State University</strong> â€” Ph.D. in Computer Science (2021â€“2026), M.S. (2021â€“2025)<br/>
    Advisor: Prof. Jim Davis Â· Minors: Mathematics, HPC Â· GPA: 3.70</p>
    <p style="margin-top: 0.5rem;"><strong>B.S. in Computer Science with Honors</strong> (2017â€“2021) Â· GPA: 3.86</p>
  </Callout>

  <!-- SKILLS SECTION -->
  <section id="skills" class="section">
    <div class="section__header">
      <h2 class="section__title">Skills</h2>
    </div>
    <div class="skills-grid">
      <div class="skill-category">
        <h4 class="skill-category__title">Core Research</h4>
        <div class="skill-category__items">
          <span class="skill-item">Selective prediction</span>
          <span class="skill-item">LLM self-assessment</span>
          <span class="skill-item">Confidence calibration</span>
          <span class="skill-item">Calibration metrics</span>
          <span class="skill-item">RL fine-tuning</span>
          <span class="skill-item">Multimodal learning</span>
        </div>
      </div>
      <div class="skill-category">
        <h4 class="skill-category__title">Models &amp; Architectures</h4>
        <div class="skill-category__items">
          <span class="skill-item">Vision transformers</span>
          <span class="skill-item">VLMs</span>
          <span class="skill-item">EO/SAR</span>
        </div>
      </div>
      <div class="skill-category">
        <h4 class="skill-category__title">Tools &amp; Infrastructure</h4>
        <div class="skill-category__items">
          <span class="skill-item">Python</span>
          <span class="skill-item">PyTorch</span>
          <span class="skill-item">HuggingFace</span>
          <span class="skill-item">vLLM</span>
          <span class="skill-item">DeepSpeed</span>
          <span class="skill-item">Slurm</span>
          <span class="skill-item">Singularity</span>
          <span class="skill-item">Linux HPC</span>
          <span class="skill-item">Git</span>
        </div>
      </div>
      <div class="skill-category">
        <h4 class="skill-category__title">Domains</h4>
        <div class="skill-category__items">
          <span class="skill-item">Defense &amp; remote sensing</span>
          <span class="skill-item">Analyst-facing tooling</span>
          <span class="skill-item">Multimodal MT</span>
        </div>
      </div>
      <div class="skill-category">
        <h4 class="skill-category__title">Service</h4>
        <div class="skill-category__items">
          <span class="skill-item">CVPR 2022â€“23</span>
          <span class="skill-item">ICCV 2023</span>
          <span class="skill-item">ECCV 2022</span>
          <span class="skill-item">HackOHI/O</span>
        </div>
      </div>
    </div>
  </section>

  <!-- PUBLICATIONS SECTION -->
  <section id="publications" class="section">
    <div class="section__header">
      <h2 class="section__title">Publications</h2>
      <span class="section__subtitle">All with runnable code</span>
    </div>
    <div class="grid grid--2">
      {publications.map((pub) => (
        <PublicationCard entry={pub} artifacts={artifactMap.get(pub.slug)} />
      ))}
    </div>
    <div class="mt-lg">
      <a class="button button--ghost button--small" href={`${import.meta.env.BASE_URL}publications/`}>
        Browse all publications â†’
      </a>
    </div>
  </section>

  <!-- ARTIFACTS SECTION -->
  <section id="artifacts" class="section">
    <div class="section__header">
      <h2 class="section__title">Open Source</h2>
      <span class="section__subtitle">Tools & datasets</span>
    </div>
    <div class="grid grid--3">
      {featuredArtifacts.map((artifact) => (
        <article class="card card--clickable">
          <div class="card__header">
            <h3 class="card__title">
              <a href={artifact.data.repo} target="_blank" rel="noopener noreferrer">
                {artifact.data.name}
              </a>
            </h3>
          </div>
          <p class="card__description">{artifact.data.summary}</p>
          <div class="card__tags">
            {artifact.data.reproduce.slice(0, 2).map((item) => (
              <span class="card__tag">{item.split(' ').slice(0, 3).join(' ')}...</span>
            ))}
          </div>
          {artifact.data.tiesTo.length > 0 && (
            <div class="card__links">
              <span class="card__link">
                Supports: {artifact.data.tiesTo
                  .map((slug) => publicationLookup.get(slug))
                  .filter(Boolean)
                  .slice(0, 1)
                  .join(', ')}
              </span>
            </div>
          )}
        </article>
      ))}
    </div>
    <div class="mt-lg">
      <a class="button button--small" href={`${import.meta.env.BASE_URL}artifacts/`}>
        View all artifacts â†’
      </a>
    </div>
  </section>

  <!-- ABOUT SECTION -->
  <section id="about" class="section">
    <div class="section__header">
      <h2 class="section__title">About</h2>
    </div>
    <div class="prose">
      {aboutRendered && <aboutRendered.Content />}
    </div>
  </section>
</BaseLayout>
