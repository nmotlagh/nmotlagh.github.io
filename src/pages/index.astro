---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import SectionHeading from '../components/SectionHeading.astro';
import NewsStrip from '../components/NewsStrip.astro';
import HighlightsRow from '../components/HighlightsRow.astro';
import PublicationCard from '../components/PublicationCard.astro';
import { getCollection, getEntry } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import headshot from '../assets/headshot.jpg';

const about = await getEntry('pages', 'about');
const experience = await getEntry('pages', 'experience');
const aboutRendered = await about.render();
const experienceItems = experience.data.items ?? [];

const publicationEntries = await getCollection('publications');
const publications = publicationEntries.sort((a, b) => b.data.year - a.data.year);

const artifactEntries = await getCollection('artifacts');
const artifactMap = new Map<string, CollectionEntry<'artifacts'>[]>();
artifactEntries.forEach((artifact) => {
  artifact.data.tiesTo.forEach((slug) => {
    if (!artifactMap.has(slug)) {
      artifactMap.set(slug, []);
    }
    artifactMap.get(slug)?.push(artifact);
  });
});
const featuredArtifacts = [...artifactEntries]
  .sort((a, b) => a.data.name.localeCompare(b.data.name))
  .slice(0, 3);

const resumeHref = `${import.meta.env.BASE_URL}resume.pdf`;
const scholarHref = 'https://scholar.google.com/citations?user=REPLACE_ME';
const githubHref = 'https://github.com/nmotlagh';
const linkedInHref = 'https://www.linkedin.com/in/nicholas-kashani-motlagh/';
const emailHref = 'mailto:motlagh.4@osu.edu';
const siteOrigin = Astro.site?.href ?? 'https://nmotlagh.github.io';
const headshotUrl = Astro.site ? new URL(headshot.src, Astro.site).href : headshot.src;

const personSchema = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Nick Kashani Motlagh',
  url: siteOrigin,
  jobTitle: 'Ph.D. Candidate; Research Scientist track 2025',
  affiliation: {
    '@type': 'CollegeOrUniversity',
    name: 'The Ohio State University',
  },
  email: emailHref,
  image: headshotUrl,
  sameAs: [githubHref, linkedInHref, scholarHref],
  knowsAbout: [
    'Vision-language models',
    'Uncertainty quantification',
    'Computer vision',
    'Multimodal machine learning',
    'Large language models',
  ],
};

const publicationSchemas = publications.map((pub) => {
  const isBasedOn = [pub.data.code, pub.data.data].filter(Boolean).map((url) => ({
    '@type': 'CreativeWork',
    url,
  }));
  return {
    '@context': 'https://schema.org',
    '@type': 'ScholarlyArticle',
    name: pub.data.title,
    url: `${siteOrigin}publications/${pub.slug}/`,
    datePublished: pub.data.datePublished ?? String(pub.data.year),
    publisher: pub.data.venue
      ? {
          '@type': 'Organization',
          name: pub.data.venue,
        }
      : undefined,
    author: pub.data.authors.map((author) => ({
      '@type': 'Person',
      name: author,
    })),
    isBasedOn: isBasedOn.length > 0 ? isBasedOn : undefined,
  };
});

const structuredData = [personSchema, ...publicationSchemas];
const publicationLookup = new Map(publications.map((entry) => [entry.slug, entry.data.title]));
---

<BaseLayout
  title="Home"
  description="Nick Kashani Motlagh is a machine learning engineer and Ph.D. candidate advancing production-ready, uncertainty-aware multimodal systems at The Ohio State University."
  structuredData={structuredData}
>
  <Hero
    eyebrow="Open research · Evaluation harnesses"
    title="Building dependable multimodal & LLM systems."
    description="Selective prediction, abstention, and evaluation tooling so multimodal models stay calibrated when shipping to production."
    actions={[
      { label: 'Resume', href: resumeHref, external: true, analyticsEvent: 'hero_resume_click' },
      { label: 'Scholar', href: scholarHref, external: true, analyticsEvent: 'hero_scholar_click' },
      { label: 'GitHub', href: githubHref, external: true, analyticsEvent: 'hero_github_click' },
      { label: 'Email', href: emailHref, variant: 'ghost', analyticsEvent: 'hero_email_click' },
    ]}
    meta={[
      'Selective prediction · Abstention policies · Calibration',
      'Open artifacts: code, data, eval harnesses',
      'Columbus, Ohio · Research scientist track 2025',
    ]}
    stats={[
      { label: 'Focus', value: 'Selective prediction & LLM ops' },
      { label: 'Current role', value: 'Ph.D. candidate · OSU CVL' },
      { label: 'Impact', value: '+8× OOD utility · +1.3% coverage' },
    ]}
    image={{ src: headshot, alt: 'Portrait of Nick Kashani Motlagh' }}
  />

  <NewsStrip />
  <HighlightsRow />

  <section id="about" class="site-shell section">
    <SectionHeading eyebrow="Profile" title="About" />
    <div class="prose">
      <aboutRendered.Content />
    </div>
  </section>

  <section id="experience" class="site-shell section">
    <SectionHeading
      eyebrow="Background"
      title="Experience"
      description="Delivery-focused research, teaching, and internships where I translated multimodal ML into rigorously evaluated systems."
    />
    <div class="timeline">
      {experienceItems.map((item) => (
        <article class="timeline__item">
          <h3 class="timeline__title">{item.role}</h3>
          <div class="timeline__meta">
            <span>{item.organization}</span>
            <span aria-hidden="true">&middot;</span>
            <span>{item.timeframe}</span>
          </div>
          <p class="timeline__body">{item.summary}</p>
        </article>
      ))}
    </div>
  </section>

  <section id="publications" class="site-shell section">
    <SectionHeading
      eyebrow="Research"
      title="Publications & articles"
      description="Peer-reviewed work spanning selective vision models, multimodal MT, and LLM abstention policies — with reproducible artifacts."
    />
    <div class="publication-grid">
      {publications.map((pub) => (
        <PublicationCard entry={pub} artifacts={artifactMap.get(pub.slug)} />
      ))}
    </div>
    <div class="section__cta">
      <a class="button button--ghost" href={`${import.meta.env.BASE_URL}publications/`}>Browse publication archive</a>
    </div>
  </section>

  <section id="artifacts" class="site-shell section">
    <SectionHeading
      eyebrow="Open source"
      title="Artifacts you can fork today"
      description="Pipelines, eval harnesses, and datasets that pair every paper with runnable code and reproducibility notes."
    />
    <div class="artifact-grid">
      {featuredArtifacts.map((artifact) => (
        <article class="artifact-card">
          <div class="artifact-card__header">
            <h3>
              <a href={artifact.data.repo} target="_blank" rel="noopener noreferrer">
                {artifact.data.name}
              </a>
            </h3>
            {artifact.data.repo && (
              <a class="badge badge--link" href={artifact.data.repo} target="_blank" rel="noopener noreferrer">
                GitHub
              </a>
            )}
          </div>
          <p>{artifact.data.summary}</p>
          <ul>
            {artifact.data.reproduce.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
          {artifact.data.tiesTo.length > 0 && (
            <p class="artifact-card__ties">
              Supports:&nbsp;
              {artifact.data.tiesTo
                .map((slug) => ({ slug, title: publicationLookup.get(slug) }))
                .filter((item): item is { slug: string; title: string } => Boolean(item.title))
                .map((item, index, arr) => (
                  <span>
                    <a href={`${import.meta.env.BASE_URL}publications/${item.slug}/`}>{item.title}</a>
                    {index < arr.length - 1 ? ', ' : ''}
                  </span>
                ))}
            </p>
          )}
        </article>
      ))}
    </div>
    <div class="section__cta">
      <a class="button" href={`${import.meta.env.BASE_URL}artifacts/`}>View all artifacts</a>
    </div>
  </section>
</BaseLayout>
